---
title: "ELFIN Data Analysis"
engine: julia
---

# ELFIN Data Analysis

This document analyzes ELFIN satellite data to find continuous time ranges and prepare for conjunction analysis with DMSP.

## Loading ELFIN Flux Data

```{julia}
using PySPEDAS.Projects
using PySPEDAS
using Speasy
using Dates
using DimensionalData

probe = "b"
tr = ["2020-01-01", "2020-03-01"]

# Load ELFIN EPD data
epd_ds = elfin.epd(tr; probe, level="l2")
elb_flux = DimArray(epd_ds.elb_pef_hs_nflux_para)
```

## Finding Continuous Time Ranges

```{julia}
using SPEDAS
using SPEDAS: times, find_continuous_timeranges

continuous_ranges = find_continuous_timeranges(elb_flux, Second(60))

# Print the continuous time ranges
println("Found $(length(continuous_ranges)) continuous time ranges:")
for (i, (start_time, end_time)) in enumerate(continuous_ranges)
    duration = end_time - start_time
    println("Range $i: $start_time to $end_time ($(round(duration, Minute)))")
end
```

Download data from Madrigal for each continuous time range

```{julia}
using MadrigalWeb
MadrigalWeb.set_default_server()
MadrigalWeb.set_default_user("Zijin+Zhang", "zijin@ucla.edu")

# timeranges_day = sort(collect(Set((floor(t0, Day), ceil(t1, Day)) for (t0, t1) in continuous_ranges)))

function dmsp_download(timerange, inst=8100, kindat=10216)
    MadrigalWeb.download_files(inst, kindat, timerange...)
end
dmsp_download.(continuous_ranges)
```


## Loading ELFIN Position Data


```{julia}
const ssc = speasy.inventories.flat_inventories.ssc
dmspf16_ssc = speasy.inventories.data_tree.ssc.Trajectories.dmspf16
elfina_ssc = speasy.inventories.data_tree.ssc.Trajectories.elfina
speasy.inventories.flat_inventories.ssc.parameters.keys()

mms1_traj = speasy.ssc.get_data(speasy.inventories.data_tree.ssc.Trajectories.mms1, "2018-01-01", "2018-02-01", "gsm")
mms1_traj.columns

dmspf16_gse = Speasy.get_data("ssc/dmspf16", "2020-01-01", "2020-01-03")
elfina_gse = Speasy.get_data("ssc/elfina", "2020-01-01", "2020-01-03")
```

```{julia}
elb_pos_gei = DimArray.(Speasy.get_data("cda/ELB_L1_STATE_DEFN/elb_pos_gei", continuous_ranges))
```

Interpolate ELFIN position data to 1 second resolution

```{julia}
using SPEDAS: tinterp
elb_pos_gei_1s = tinterp(elb_pos_gei, Second(1))
